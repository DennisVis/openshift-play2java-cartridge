#!/bin/bash -eu

case "$1" in
  -v|--version)
    version="$2"
esac

# Create environment variables
echo "${OPENSHIFT_PLAY2JAVA_DIR}logs/" > ${OPENSHIFT_PLAY2JAVA_DIR}env/OPENSHIFT_PLAY2JAVA_LOG_DIR
echo -n "" > ${OPENSHIFT_PLAY2JAVA_DIR}logs/play.log
echo "$version" > ${OPENSHIFT_PLAY2JAVA_DIR}env/PLAY_VERSION
< /dev/urandom tr -dc a-zA-Z0-9@#$%*-_+=~ | head -c64 > ${OPENSHIFT_PLAY2JAVA_DIR}env/CRYPTO_KEY

# Create path elements
echo ${OPENSHIFT_PLAY2JAVA_DIR}/versions/play-$version > ${OPENSHIFT_PLAY2JAVA_DIR}env/OPENSHIFT_PLAY2JAVA_PATH_ELEMENT

# Build application

# Make sure build process does not take more memory then allowed
export _JAVA_OPTIONS="-Xms502m -Xmx502m"

echo
  (cd "${OPENSHIFT_REPO_DIR}"; ${OPENSHIFT_PLAY2JAVA_DIR}/versions/play-$version/play clean compile stage) >> ${OPENSHIFT_PLAY2JAVA_DIR}logs/play.log
